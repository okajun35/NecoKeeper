{
  "enabled": true,
  "name": "Test Coverage Analyzer",
  "description": "テストカバレッジを詳細分析して改善提案。カバレッジが低いファイルを特定し、不足しているテストケースを提案します。",
  "version": "1",
  "when": {
    "type": "userTriggered"
  },
  "then": {
    "type": "askAgent",
    "prompt": "テストカバレッジを分析して改善提案を行います。\n\n## 1. 現在のカバレッジ測定\n\n```bash\npytest --cov=app --cov-report=term-missing --cov-report=html\n```\n\nカバレッジレポートを生成して、以下の情報を抽出してください：\n- 全体のカバレッジ率\n- レイヤー別のカバレッジ（models/、services/、api/、auth/、utils/）\n- カバレッジが低いファイル（70%未満）のリスト\n\n## 2. カバレッジ目標との比較\n\n### 目標値\n- **ドメイン層（models/）**: 90%以上\n- **サービス層（services/）**: 80%以上\n- **API層（api/）**: 70%以上\n- **認証層（auth/）**: 80%以上\n- **ユーティリティ層（utils/）**: 70%以上\n- **全体**: 70%以上（最終目標80%）\n\n各レイヤーについて、目標達成状況を報告してください。\n\n## 3. 優先度付けと分析\n\nカバレッジが目標未達のファイルについて、以下の基準で優先度を付けてください：\n\n### 優先度：高（即座に改善すべき）\n- ビジネスロジックを含むサービス層で50%未満\n- 認証・認可に関わるコードで70%未満\n- 最近変更されたファイルで60%未満\n\n### 優先度：中（近日中に改善）\n- サービス層で50-80%\n- API層で50-70%\n- ユーティリティ層で50%未満\n\n### 優先度：低（時間があれば改善）\n- その他のファイルで目標未達\n\n## 4. 不足しているテストケースの特定\n\n優先度が高いファイル（最大3つ）について、以下を分析してください：\n\n### 各ファイルについて\n\n1. **未テストの関数/メソッドを特定**\n   - カバレッジレポートの「Missing lines」から特定\n   - 各関数の役割を分析\n\n2. **不足しているテストの種類を分類**\n   - ✅ 正常系テスト: 期待通りの入力で正しく動作するか\n   - ✅ 異常系テスト: エラーハンドリングが適切か\n   - ✅ 境界値テスト: エッジケースで正しく動作するか\n   - ✅ 副作用テスト: データベース変更、ログ記録などの副作用を検証\n\n3. **具体的なテストケースを提案**\n   - Given-When-Thenパターンで記述\n   - Pytestのパラメータ化テストを活用\n   - フィクスチャの適切な使用\n\n## 5. テストケース生成（オプション）\n\n最も優先度が高いファイル1つについて、実際にテストケースを生成しますか？\n\nYesの場合：\n1. 不足しているテストケースを実装\n2. tests/配下の適切な場所に保存\n3. pytest を実行して動作確認\n4. カバレッジの改善度を測定\n\n## 6. サマリーレポート\n\n以下の形式でレポートを作成してください：\n\n```\n📊 テストカバレッジ分析レポート\n=====================================\n\n## 現在のカバレッジ\n- 全体: XX%\n- ドメイン層: XX%\n- サービス層: XX%\n- API層: XX%\n- 認証層: XX%\n- ユーティリティ層: XX%\n\n## 目標達成状況\n✅ 達成: [リスト]\n⚠️ 未達: [リスト]\n\n## 改善が必要なファイル（優先度順）\n\n### 優先度：高\n1. app/services/xxx.py (現在: XX%, 目標: 80%)\n   - 不足: 正常系テスト3件、異常系テスト2件\n   - 推定工数: 30分\n\n2. ...\n\n### 優先度：中\n...\n\n## 推奨アクション\n1. [最優先で対応すべきファイルとテストケース]\n2. [次に対応すべき項目]\n3. [長期的な改善計画]\n\n## 次のステップ\n- [ ] 優先度：高のファイルのテストを追加\n- [ ] カバレッジを再測定\n- [ ] 目標達成を確認\n```\n\n## 7. HTMLレポートの案内\n\n詳細なカバレッジレポートは以下で確認できます：\n```bash\n# Linuxの場合\nxdg-open htmlcov/index.html\n\n# macOSの場合\nopen htmlcov/index.html\n\n# Windowsの場合\nstart htmlcov/index.html\n```\n\nHTMLレポートでは：\n- ファイルごとの詳細なカバレッジ\n- 未実行の行が赤色でハイライト\n- 関数ごとのカバレッジ統計\nを確認できます。"
  },
  "workspaceFolderName": "NecoKeeper",
  "shortName": "test_coverage_analyzer"
}
