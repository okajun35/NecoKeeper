#!/bin/bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Render Free Planç”¨: èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–

set -e

echo "ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å­˜åœ¨ç¢ºèª..."

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿åˆæœŸåŒ–
if [ ! -f "/tmp/data/necokeeper.db" ]; then
    echo "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™..."

    # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    echo "ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œä¸­..."
    alembic upgrade head

    # åˆæœŸç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
    echo "ğŸ‘¤ åˆæœŸç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆä¸­..."
    python -c "
from app.database import SessionLocal
from app.models.user import User
from app.auth.password import hash_password

db = SessionLocal()
try:
    # æ—¢å­˜ã®ç®¡ç†è€…ã‚’ãƒã‚§ãƒƒã‚¯
    existing_admin = db.query(User).filter(User.email == 'admin@example.com').first()
    if not existing_admin:
        admin = User(
            email='admin@example.com',
            password_hash=hash_password('admin123'),
            name='ç®¡ç†è€…',
            role='admin',
            is_active=True
        )
        db.add(admin)
        db.commit()
        print('âœ… ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå®Œäº†')
    else:
        print('â„¹ï¸  ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™')
except Exception as e:
    print(f'âŒ ã‚¨ãƒ©ãƒ¼: {e}')
    db.rollback()
finally:
    db.close()
"

    echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å®Œäº†"
else
    echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
fi

echo "ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¾ã™..."
exec uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000}
