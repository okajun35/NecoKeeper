# OCR世話記録インポートガイド

## 概要

このガイドでは、Kiroを使用して手書きの世話記録表（画像またはPDFファイル）をNecoKeeperデータベースにインポートする方法を説明します。Kiroはオーケストレーターとして、マルチモーダルLLM解析、Hookスクリプト、NecoKeeper APIを連携させます。

## 前提条件

### システム要件
- Kiro AIアシスタントがインストールされ、実行中であること
- NecoKeeper APIサーバーが実行中であること（デフォルト: http://localhost:8000）
- Python 3.10+と必要な依存関係がインストールされていること
- NecoKeeper APIの管理者認証情報

### 環境設定

1. **環境変数の設定**（`.env`ファイル）:
```bash
NECOKEEPER_API_URL=http://localhost:8000
NECOKEEPER_ADMIN_USERNAME=admin
NECOKEEPER_ADMIN_PASSWORD=your_secure_password
OCR_TEMP_DIR=tmp/images
OCR_LOG_FILE=logs/ocr-import.log
```

2. **ディレクトリ構造の確認**:
```bash
scripts/
├── hooks/
│   ├── pdf_to_image.py
│   └── register_care_logs.py
└── utils/
    ├── cat_identifier.py
    ├── json_schema.py
    ├── data_mapper.py
    └── prompt_template.py

tmp/
└── images/  # 一時画像保存

logs/
└── ocr-import.log  # インポートログ
```

3. **API接続のテスト**:
```bash
curl http://localhost:8000/api/v1/health
```

## ワークフロー概要

### 全体の流れ


```
ユーザー → Kiro: プロンプト + 画像/PDF
  ↓
Kiro: プロンプト解析（猫ID/名前、年月）
  ↓
Kiro: ファイル種別検出（.pdf, .jpg, .png）
  ↓
[PDFの場合] → Hook: PDFを画像に変換
  ↓
Kiro: 猫の特定（IDまたは名前で）
  ↓
Kiro + LLM: 構造化プロンプトで画像解析
  ↓
Kiro: 抽出されたJSONデータの検証
  ↓
Hook: API経由でレコード登録
  ↓
Kiro → ユーザー: サマリーレポート
```

## 使用方法

### シナリオ1: 画像ファイル（JPG/PNG）からのインポート

#### ステップ1: プロンプトの準備

プロンプトには以下を含める必要があります：
1. **猫の識別子**: 動物ID（整数）または猫の名前（文字列）
2. **年月**: 日付解析用（形式: YYYY年MM月 または YYYY-MM）
3. **アクション**: インポート/登録の明確な指示

**プロンプト例**:
```
この画像からID5の猫の2025年11月の記録を登録して
```
```
この画像から猫「たま」の2025年5月の世話記録をインポートして
```
```
猫ID3の2025年11月の記録をこの画像から取り込んで
```

#### ステップ2: 画像ファイルの添付

Kiroチャットで:
1. 画像添付ボタン（📎 または 🖼️）をクリック
2. 手書き世話記録表の画像（.jpgまたは.png）を選択
3. 画像には日付、時間帯、世話記録が記載された表が写っている必要があります

#### ステップ3: プロンプトの送信

画像を添付してプロンプトを送信すると、Kiroは以下を実行します：


1. **プロンプトの解析**で以下を抽出:
   - 猫の識別子（IDまたは名前）
   - 日付コンテキスト用の年月

2. **猫の特定**:
   - IDを指定した場合、存在を確認
   - 名前を指定した場合、一致する猫を検索
   - 曖昧または一致なしの場合を処理

3. **マルチモーダルLLMで画像解析**:
   - 表構造の抽出
   - 手書き文字の読み取り
   - 記号（○/△/×）を値にマッピング
   - 構造化JSONの生成

4. **抽出データの検証**:
   - 必須フィールドの確認
  - 値の範囲確認（食欲: 1.0/0.75/0.5/0.25/0.0、元気: 1-5）
   - 日付と時間帯の検証
   - ブール値フィールドの正確性確認

5. **Hookスクリプト経由でレコード登録**:
   - NecoKeeper APIで認証
   - 各レコードを個別に送信
   - 個別の失敗時も処理継続
   - 成功/失敗の統計を収集

6. **結果のレポート**:
   - 処理されたレコード総数
   - 成功した登録数
   - 失敗したレコードと理由

#### ステップ4: 結果の確認

Kiroは以下のようなサマリーを表示します：
```
✅ インポートが正常に完了しました！

サマリー:
- 総レコード数: 15
- 成功: 15
- 失敗: 0

猫ID 5の世話記録（2025年11月）がすべて登録されました。
```

エラーがある場合:
```
⚠️ インポートが一部エラーで完了しました

サマリー:
- 総レコード数: 15
- 成功: 12
- 失敗: 3

失敗したレコード:
1. 2025-11-10 朝: 食欲の値が範囲外
2. 2025-11-15 昼: 日付形式が無効
3. 2025-11-20 夕: 必須フィールドが不足

詳細は logs/ocr-import.log を確認してください。
```

### シナリオ2: PDFファイルからのインポート


#### ステップ1: プロンプトの準備

画像インポートと同様ですが、PDFであることを明示的に記載します：

**プロンプト例**:
```
このPDFから猫「あみ」の2025年5月の記録を登録して
```
```
PDFファイルからID7の猫の2025年12月の世話記録をインポート
```

#### ステップ2: PDFファイルの添付

Kiroチャットで:
1. ファイル添付ボタンをクリック
2. 世話記録表を含むPDFファイルを選択
3. 最初のページのみが処理されます

#### ステップ3: プロンプトの送信

Kiroは以下を実行します：

1. **PDFファイル拡張子を検出**（.pdf）

2. **PDF変換Hookを呼び出し**:
   ```bash
   python scripts/hooks/pdf_to_image.py <pdf_path>
   ```
   - 最初のページをPNG画像に変換
   - `tmp/images/`に保存
   - 画像パスを返す

3. **画像処理を継続**（シナリオ1と同様）:
   - プロンプト解析
   - 猫の特定
   - LLMで画像解析
   - データ検証
   - レコード登録

4. **一時ファイルのクリーンアップ**:
   - 処理後に変換された画像を削除

#### ステップ4: 結果の確認

画像インポートと同じサマリー形式です。

### シナリオ3: エラー処理

#### 猫が見つからない
```
❌ エラー: 猫が見つかりません

猫の識別子「たろう」はデータベース内のどの猫とも一致しません。

登録されている猫:
- ID 1: たま
- ID 2: みけ
- ID 3: あみ
- ID 5: くろ

猫の名前を確認するか、猫IDを使用してください。
```

**解決方法**: 猫の識別子を修正して再試行してください。

#### 複数の猫が見つかった
```
⚠️ 曖昧な猫の識別子

名前「たま」に一致する猫が複数います:
- ID 1: たま（キジトラ）
- ID 8: たま（三毛）

曖昧さを避けるため、猫IDを指定してください。
```

**解決方法**: 名前の代わりに特定の猫IDを使用してください。


#### 画像品質の問題
```
⚠️ 画像品質の問題

LLMが画像の一部を確実に読み取れませんでした。

不確実性のあるレコード:
- 2025-11-05 朝: 「ごはん」フィールドが不明瞭（?でマーク）
- 2025-11-12 夕: 日付が部分的に読み取れない

推奨事項:
1. より良い照明で写真を撮り直す
2. テキストにピントが合っていることを確認
3. 影や反射を避ける
4. より高解像度でスキャン

次のいずれかを選択してください:
- 部分的なデータで続行
- キャンセルしてより良い画像で再試行
```

**解決方法**: より鮮明な画像を提供するか、不確実なフィールドを手動で確認してください。

#### PDF変換失敗
```
❌ PDF変換エラー

PDFを画像に変換できませんでした。

エラー詳細:
- ファイル: care_log_202511.pdf
- 原因: PDFが破損しているか、サポートされていない形式

以下を確認してください:
1. PDFファイルが破損していない
2. PDFがパスワード保護されていない
3. PDFに実際のページが含まれている（空でない）

試してください:
- 元のソースからPDFを再エクスポート
- 手動で画像に変換して画像をアップロード
```

**解決方法**: PDFファイルを修正するか、代わりに画像形式を使用してください。

#### API認証失敗
```
❌ 認証エラー

NecoKeeper APIでの認証に失敗しました。

エラー: 認証情報が無効です

以下を確認してください:
1. NECOKEEPER_ADMIN_USERNAMEが正しい
2. NECOKEEPER_ADMIN_PASSWORDが正しい
3. 管理者アカウントが存在し、アクティブである
4. APIサーバーが http://localhost:8000 で実行中

.envファイルを確認し、必要に応じて再起動してください。
```

**解決方法**: `.env`ファイルの認証情報を確認してください。

## 技術詳細

### ファイル拡張子の検出

Kiroは拡張子に基づいてファイルタイプを自動検出します：

```python
# ファイル検出ロジックの疑似コード
def detect_file_type(file_path: str) -> str:
    extension = file_path.lower().split('.')[-1]

    if extension == 'pdf':
        return 'pdf'
    elif extension in ['jpg', 'jpeg', 'png']:
        return 'image'
    else:
        raise ValueError(f"サポートされていないファイルタイプ: {extension}")
```

**サポートされている形式**:
- PDF: `.pdf`
- 画像: `.jpg`, `.jpeg`, `.png`


### プロンプト解析ロジック

Kiroはプロンプトから重要な情報を抽出します：

#### 猫の識別子抽出

**認識されるパターン**:
- `ID<数字>`: 例: "ID5", "ID 3", "id7"
- `猫「<名前>」`: 例: "猫「たま」", "猫「あみ」"
- `<名前>の`: 例: "たまの記録", "あみの世話"

**例**:
```python
# プロンプト: "この画像からID5の猫の記録を登録"
# 抽出: cat_id = 5

# プロンプト: "猫「たま」の2025年11月の記録"
# 抽出: cat_name = "たま"

# プロンプト: "あみの世話記録をインポート"
# 抽出: cat_name = "あみ"
```

#### 年月の抽出

**認識されるパターン**:
- `YYYY年MM月`: 例: "2025年11月", "2025年5月"
- `YYYY-MM`: 例: "2025-11", "2025-05"
- `YYYY/MM`: 例: "2025/11", "2025/05"

**デフォルト動作**:
- 年月が指定されていない場合、現在の年月を使用
- 月が1-12の範囲内であることを検証
- 年が妥当な範囲（2020-2030）であることを検証

**例**:
```python
# プロンプト: "2025年11月の記録を登録"
# 抽出: year = 2025, month = 11

# プロンプト: "2025-05の記録をインポート"
# 抽出: year = 2025, month = 5

# プロンプト: "この画像から記録を登録"（日付指定なし）
# 抽出: year = 2025, month = 11（現在の日付）
```

### LLM呼び出し

KiroはマルチモーダルLLM用の構造化プロンプトを構築します：

#### プロンプトテンプレート構造

```
あなたは手書きの猫世話記録表を解析するOCRアシスタントです。

画像から以下の情報を抽出し、JSON形式で出力してください：

【対象猫】
- animal_id: {animal_id}

【対象期間】
- year: {year}
- month: {month}

【抽出する項目】
1. 日付（M/D形式）
2. 時間帯（朝/昼/夕）
3. ごはん（○/△/×）
4. 元気（○/△/×）
5. 排尿（○/×/数字）
6. 排便（○/×）
7. 嘔吐（○/×）
8. 投薬（○/×）
9. 備考（手書きメモ）

【出力形式】
[世話記録のJSON配列]

【マッピングルール】
- ごはん: ○→5, △→3, ×→1
- 元気: ○→5, △→3, ×→1
- 排尿: ○→true, ×→false
- 朝→morning, 昼→noon, 夕→evening
...
```

#### LLMレスポンスの処理

KiroはJSON配列レスポンスを期待します：
```json
[
  {
    "animal_id": 5,
    "log_date": "2025-11-04",
    "time_slot": "morning",
    "appetite": 1.0,
    "energy": 5,
    "urination": true,
    "cleaning": false,
    "memo": "排便: あり, 嘔吐: なし",
    "recorder_name": "OCR自動取込",
    "from_paper": true
  }
]
```


### Hook呼び出しシーケンス

#### 1. PDF変換Hook（PDFファイルの場合）

**コマンド**:
```bash
python scripts/hooks/pdf_to_image.py <pdf_path>
```

**入力**: PDFファイルパス
**出力**: 画像ファイルパス（JSON形式）
```json
{
  "success": true,
  "image_path": "tmp/images/care_log_202511_page1.png"
}
```

**エラー処理**:
- ファイルが見つからない → 処理を停止、ユーザーに通知
- 変換失敗 → 処理を停止、詳細をユーザーに通知
- エラー時のクリーンアップ → 部分的なファイルを削除

#### 2. 猫の特定（API経由）

**API呼び出し**:
```bash
GET /api/v1/animals
Authorization: Bearer <token>
```

**処理**:
1. APIからすべての動物を取得
2. IDまたは名前でメモリ内検索（大文字小文字を区別しない）
3. 一致するanimal_idを返す

**エラー処理**:
- 一致なし → 処理を停止、利用可能な猫をリスト表示
- 複数一致 → 処理を停止、明確化を要求
- APIエラー → 3回リトライ、その後停止

#### 3. データ登録Hook

**コマンド**:
```bash
python scripts/hooks/register_care_logs.py <json_file_path>
```

**入力**: 世話記録のJSONファイル
**出力**: 登録サマリー
```json
{
  "status": "success",
  "summary": {
    "total_records": 15,
    "successful": 15,
    "failed": 0
  },
  "errors": []
}
```

**処理**:
1. APIで認証（POST /api/v1/auth/token）
2. 各レコードに対して:
   - POST /api/v1/care-logs
   - 成功または失敗をログ
   - 個別の失敗時も継続
3. 統計を含むサマリーを返す

**エラー処理**:
- 認証失敗 → 処理を停止、ユーザーに通知
- ネットワークエラー → 指数バックオフで3回リトライ
- 個別レコード失敗 → エラーをログ、次のレコードに継続
- すべてのレコード失敗 → 詳細を含む失敗を報告

### エラー処理戦略

#### エラーカテゴリと対応

| エラータイプ | 重要度 | アクション | ユーザー通知 |
|------------|--------|-----------|-------------|
| ファイルが見つからない | 重大 | 停止 | 即座にエラーメッセージ |
| PDF変換失敗 | 重大 | 停止 | エラー詳細 + 提案 |
| 猫が見つからない | 重大 | 停止 | 利用可能な猫をリスト表示 |
| 複数の猫が見つかった | 警告 | 停止 | 明確化を要求 |
| 画像品質が悪い | 警告 | 継続 | 不確実なフィールドをマーク |
| 無効な日付 | 軽微 | レコードをスキップ | ログ + 継続 |
| 値が範囲外 | 軽微 | レコードをスキップ | ログ + 継続 |
| API認証失敗 | 重大 | 停止 | 認証情報を確認 |
| ネットワークエラー | 回復可能 | 3回リトライ | すべて失敗時に通知 |
| 個別レコード失敗 | 軽微 | 継続 | サマリーに含める |

#### 進捗レポート

Kiroはリアルタイムで進捗を更新します：

```
🔄 OCRインポート処理を開始しています...

✓ ファイル検出: care_log_202511.jpg（画像）
✓ プロンプト解析: cat_id=5, year=2025, month=11
✓ 猫を特定: ID 5（たま）

🤖 LLMで画像を解析中...
✓ 画像から15件のレコードを抽出

🔍 データを検証中...
✓ すべてのレコードが検証に合格

📤 API経由でレコードを登録中...
✓ APIで認証完了
✓ 15/15件のレコードを登録

✅ インポートが正常に完了しました！
```

エラーがある場合:
```
🔄 OCRインポート処理を開始しています...

✓ ファイル検出: care_log_202511.pdf（PDF）
✓ PDFを画像に変換中...
✓ 画像を保存: tmp/images/care_log_202511_page1.png
✓ プロンプト解析: cat_name="たま", year=2025, month=11
✓ 猫を特定: ID 5（たま）

🤖 LLMで画像を解析中...
⚠️ 画像品質の問題を検出
✓ 15件のレコードを抽出（3件に不確実性あり）

🔍 データを検証中...
⚠️ 2件のレコードが検証に失敗

📤 API経由でレコードを登録中...
✓ APIで認証完了
✓ 13/15件のレコードを登録
⚠️ 2件のレコードが失敗

⚠️ インポートが警告付きで完了しました
```


## データマッピングリファレンス

### 記号マッピング

| 手書き記号 | フィールド | マッピング値 | 備考 |
|-----------|----------|------------|------|
| ○ | ごはん（appetite） | 1.0 | 完食 |
| △ | ごはん（appetite） | 0.5 | 半分残し |
| × | ごはん（appetite） | 0.0 | 食べない |
| ○ | 元気（energy） | 5 | とても元気 |
| △ | 元気（energy） | 3 | 普通の元気 |
| × | 元気（energy） | 1 | 元気がない |
| ○ | 排尿（urination） | true | 排尿あり |
| × | 排尿（urination） | false | 排尿なし |
| 数字（1,2,3...） | 排尿（urination） | true | 回数はmemoに追加 |
| ○ | 排便（defecation） | "排便: あり" | memoに追加 |
| × | 排便（defecation） | "排便: なし" | memoに追加 |
| ○ | 嘔吐（vomiting） | "嘔吐: あり" | memoに追加 |
| × | 嘔吐（vomiting） | "嘔吐: なし" | memoに追加 |
| ○ | 投薬（medication） | "投薬: あり" | memoに追加 |
| × | 投薬（medication） | "投薬: なし" | memoに追加 |

### 時間帯マッピング

| 日本語 | 英語 | 時間範囲 |
|-------|------|---------|
| 朝 | morning | ~12:00 |
| 昼 | noon | 12:00-18:00 |
| 夕 | evening | 18:00~ |

### OCRインポートのデフォルト値

すべてのOCRインポートレコードには自動的に以下が含まれます：

```json
{
  "recorder_name": "OCR自動取込",
  "recorder_id": null,
  "from_paper": true,
  "device_tag": "OCR-Import",
  "cleaning": false,
  "ip_address": null,
  "user_agent": null
}
```

## トラブルシューティング

### よくある問題

#### 問題: "Command not found: python"

**原因**: PythonがPATHにないか、Pythonバージョンが間違っている

**解決方法**:
```bash
# Pythonバージョンを確認
python --version  # 3.10+である必要があります

# またはpython3を試す
python3 --version

# 必要に応じてHookコマンドをpython3に更新
```

#### 問題: "Module not found: pdf2image"

**原因**: 依存関係が不足している

**解決方法**:
```bash
# 必要なパッケージをインストール
pip install -r requirements.txt

# または個別にインストール
pip install pdf2image Pillow requests pydantic python-dotenv
```

#### 問題: "API connection refused"

**原因**: NecoKeeper APIが実行されていない

**解決方法**:
```bash
# APIサーバーを起動
uvicorn app.main:app --reload

# または既に実行中か確認
curl http://localhost:8000/api/v1/health
```

#### 問題: "Permission denied: tmp/images/"

**原因**: ディレクトリが存在しないか、書き込み権限がない

**解決方法**:
```bash
# ディレクトリを作成
mkdir -p tmp/images logs

# 権限を設定
chmod 755 tmp/images logs
```

#### 問題: "Invalid JSON response from LLM"

**原因**: LLMが不正なJSONまたは非JSON形式のテキストを返した

**解決方法**:
1. 画像品質を確認 - テキストが読み取れることを確認
2. より鮮明な画像で再試行
3. LLMプロンプトテンプレートが正しいか確認
4. ログでJSON構造を手動で確認

### デバッグモード

トラブルシューティング用の詳細ログを有効化：

```bash
# 環境変数を設定
export OCR_DEBUG=true

# または.envファイルで
OCR_DEBUG=true
```

これにより以下が有効になります：
- すべてのAPIリクエスト/レスポンスをログ
- 中間JSONファイルを保存
- 一時画像ファイルを保持
- 詳細なエラースタックトレースを表示

### ログファイル

詳細なエラー情報はログで確認：

```bash
# 最新のログを表示
tail -f logs/ocr-import.log

# エラーを検索
grep ERROR logs/ocr-import.log

# 特定のインポートセッションを表示
grep "2025-11-23" logs/ocr-import.log
```

ログ形式:
```
2025-11-23 14:30:15 INFO OCRインポート処理を開始
2025-11-23 14:30:16 INFO ファイル検出: care_log.jpg（画像）
2025-11-23 14:30:16 INFO 猫を特定: ID 5（たま）
2025-11-23 14:30:20 INFO LLM解析完了: 15件のレコードを抽出
2025-11-23 14:30:21 WARNING レコード検証失敗: appetite=7が範囲外
2025-11-23 14:30:25 INFO 登録完了: 14/15件成功
2025-11-23 14:30:25 ERROR 失敗したレコード: 2025-11-10 朝 - 検証エラー
```


## ベストプラクティス

### 画像品質ガイドライン

最良のOCR結果を得るために：

1. **照明**:
   - 自然光または明るい室内照明を使用
   - 書類全体に影がかからないようにする
   - 反射や光沢を避ける

2. **フォーカス**:
   - テキストがシャープでピントが合っていることを確認
   - カメラを安定させるか三脚を使用
   - モーションブラーを避ける

3. **角度**:
   - 真上から撮影（90度の角度）
   - 遠近感の歪みを避ける
   - 書類を平らに保つ

4. **解像度**:
   - 最低1200x1600ピクセル
   - スキャン文書は300 DPI
   - スキャンにはPNG形式を推奨

5. **コントラスト**:
   - 白い紙に濃いインクを使用
   - テキストと背景の良好なコントラストを確保
   - 薄い色や退色したインクを避ける

### プロンプト作成のコツ

1. **明確に記述**:
   ```
   ✅ 良い例: "この画像からID5の猫の2025年11月の記録を登録して"
   ❌ 悪い例: "これを登録"
   ```

2. **具体的な識別子を使用**:
   ```
   ✅ 良い例: "ID5" または "猫「たま」"
   ❌ 悪い例: "あの猫" または "最初の猫"
   ```

3. **日付コンテキストを含める**:
   ```
   ✅ 良い例: "2025年11月の記録"
   ❌ 悪い例: "先月の記録"
   ```

4. **1プロンプトに1リクエスト**:
   ```
   ✅ 良い例: 1画像、1匹の猫、1ヶ月
   ❌ 悪い例: 複数の画像または複数の猫を1プロンプトで
   ```

### バッチ処理

複数ファイルの場合：

1. **1つずつ処理**:
   - 1プロンプトで1画像/PDFをインポート
   - 次のインポート前に結果を確認
   - エラー追跡が容易

2. **月ごとにファイルを整理**:
   ```
   care_logs/
   ├── 2025-11/
   │   ├── cat_5_week1.jpg
   │   ├── cat_5_week2.jpg
   │   └── cat_5_week3.jpg
   └── 2025-12/
       └── cat_5_week1.jpg
   ```

3. **一貫した命名を使用**:
   - ファイル名に猫ID/名前を含める
   - ファイル名に年月を含める
   - 例: `cat5_202511_week1.jpg`

### データ検証

インポート後：

1. **データベースを確認**:
   ```sql
   SELECT * FROM care_logs
   WHERE animal_id = 5
   AND log_date BETWEEN '2025-11-01' AND '2025-11-30'
   AND from_paper = true
   ORDER BY log_date, time_slot;
   ```

2. **レコード数を確認**:
   - 期待されるレコード数と比較
   - 欠落している日付や時間帯を確認

3. **値をスポットチェック**:
   - 食欲/元気の値が妥当か確認
   - memoフィールドの正しい集約を確認
   - 時間帯が正しいことを確認

4. **エラーログを確認**:
   - スキップされたレコードを確認
   - 検証エラーが適切だったか確認
   - 予期しない失敗を調査

## よくある質問（FAQ）

### Q: 1つの画像から複数の猫をインポートできますか？

**A**: いいえ、現在各インポートは1匹の猫のみです。画像に複数の猫の記録が含まれている場合：
1. 画像を切り取って1匹の猫の記録のみを表示
2. 適切なプロンプトで各猫を個別にインポート

### Q: 手書きが英語の場合はどうなりますか？

**A**: システムは日本語の手書きフォーム用に設計されていますが、英語テキストも処理できます。プロンプトでKiroが解析できる形式で猫と日付を明確に指定してください。

### Q: 何年も前の履歴データをインポートできますか？

**A**: はい、プロンプトで任意の年月を指定できます。システムは年が妥当な範囲（デフォルトで2020-2030）であることを検証しますが、必要に応じて調整できます。

### Q: 同じデータを2回インポートするとどうなりますか？

**A**: システムは重複レコードを作成します。自動重複検出はありません。重複を避けるため、再インポート前にデータベースを確認してください。

### Q: インポート後にレコードを編集できますか？

**A**: はい、NecoKeeperのWebインターフェースまたはAPIを使用してインポートされたレコードを編集できます。レコードは`from_paper=true`でマークされているため、簡単に識別できます。

### Q: 部分的に記入されたフォームはどう処理されますか？

**A**: LLMは利用可能なデータを抽出し、欠落フィールドにはデフォルト値を使用します。どのフィールドが入力されたかはインポートサマリーで確認してください。

### Q: 日付形式が異なる場合はどうなりますか？

**A**: システムはM/D形式（例: 11/4は11月4日）を期待します。フォームが異なる形式を使用している場合、プロンプトテンプレートを手動で調整する必要がある場合があります。

### Q: 複数ページのPDFからインポートできますか？

**A**: 現在、最初のページのみが処理されます。複数ページの文書の場合：
1. PDFを単一ページに分割
2. 各ページを個別にインポート
3. またはすべてのページを画像に変換して個別にインポート

### Q: インポート処理にはどのくらい時間がかかりますか？

**A**: 一般的なタイミング：
- PDF変換: 2-5秒
- LLM解析: 10-30秒（画像の複雑さによる）
- データ登録: レコードあたり1-2秒
- 合計: 15レコードで約30-60秒

### Q: 画像サイズに制限はありますか？

**A**: 推奨制限：
- 画像ファイル: 最大10MB
- PDFファイル: 最大50MB
- 解像度: 300-600 DPI最適

### Q: LLMが間違えた場合はどうなりますか？

**A**: インポートサマリーを確認し、ログをチェックしてください。以下ができます：
1. Webインターフェース経由でレコードを手動修正
2. 不正なレコードを削除して再インポート
3. プロンプトテンプレートを改善するためのフィードバックを提供

## サポート

### ヘルプの入手

1. **ログを確認**: `logs/ocr-import.log`
2. **このガイドを確認**: よくある問題と解決方法
3. **サンプルデータでテスト**: 提供されたテスト画像を使用
4. **管理者に連絡**: APIまたはデータベースの問題について

### 問題の報告

問題を報告する際は、以下を含めてください：
- Kiroバージョン
- Pythonバージョン
- ログからのエラーメッセージ
- サンプル画像（可能な場合）
- 使用したプロンプト
- 期待される動作と実際の動作

### 貢献

OCRインポートシステムを改善するために：
1. バグやエッジケースを報告
2. プロンプトテンプレートの改善を提案
3. サンプル手書きフォームを提供
4. ベストプラクティスを共有

---

**最終更新**: 2025-11-23
**バージョン**: 1.0
**要件**: Kiro、NecoKeeper API、Python 3.10+
