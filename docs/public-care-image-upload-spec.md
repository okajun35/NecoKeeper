# public/care 画像登録仕様（PoC）

最終更新: 2026-02-08

## 1. 目的

`/public/care` から、言葉だけでは伝わりにくい気づきを写真付きで記録し、管理者側で確認できるようにする。

## 2. スコープ

- 対象: Public世話記録フォームの「写真登録」。
- 非対象: 猫プロフィール画像、OCRインポート画像、動画アップロード。

## 3. 実装済み仕様（現状）

### 3.1 入力仕様（public）

- 1回の世話記録につき画像は任意で1枚。
- 対応形式は `JPEG/PNG/WebP`。
- `HEIC/HEIF` は非対応（「HEICは非対応。JPEGで再投稿」エラーを返す）。
- 編集モード（`log_id` 指定）では画像アップロード不可。新規登録時のみ画像送信可。
- オフライン時は画像付き送信不可（オンライン時のみ）。

### 3.2 サイズ・圧縮仕様

- 受信上限: `CARE_LOG_IMAGE_RECEIVE_MAX_SIZE_MB`（既定 `10MB`）。
- 保存上限: `CARE_LOG_IMAGE_MAX_SIZE_MB`（既定 `2MB`）。
- 保存時はサーバ側で圧縮して `WebP` で保存する。
- 圧縮の試行順:
1. 長辺 `CARE_LOG_IMAGE_MAX_LONG_EDGE`（既定 `1920`）で `quality 75/65/55/45`
2. 失敗時は長辺 `CARE_LOG_IMAGE_FALLBACK_LONG_EDGE`（既定 `1280`）で `quality 75/65/55/45`
- それでも保存上限を超える場合はエラーで保存しない。
- リサイズはアスペクト比を維持する。
- 画像保存時に再エンコードするため、EXIFメタデータは保持しない。

### 3.3 保存・公開仕様

- 画像は非公開領域 `./data/private/care_log_images` 配下に保存。
- 公開URL直配信はしない。管理画面の認証付きAPI経由でのみ閲覧。
- public側では投稿後に画像を再表示しない（管理者確認用）。
- 管理画面の世話記録詳細では画像サムネイルと拡大表示が可能。

### 3.4 欠損・削除の扱い

- `care_image_deleted_at`: 意図的な削除を示す。
- `care_image_missing_at`: 実ファイル欠損を示す。
- 実ファイル欠損を検知した場合は `care_image_missing_at` を記録し、監査ログ `care_log_image_missing_detected` を作成する。

## 4. 運用ポリシー（合意済み・未実装）

以下は運用安定化のための方針であり、現時点では未実装。

- admin側に「画像を無効化（非表示化）」操作を追加する。
- 無効化時は理由入力を必須にする。
- 監査ログに実施者・日時・理由を必ず残す。
- public側には画像閲覧機能を追加しない（プライバシー/セキュリティ優先）。
- 将来の差し替え機能が必要な場合も admin限定で実装する。

## 5. 画面仕様の要点（誤解防止）

- public:
1. メモ + 写真を送信できる。
2. 画像入力はカメラアイコン付き「写真を追加」ボタンで行う。
3. 送信後、画像はpublic画面に表示されない。
4. 編集時に画像差し替えはできない。
- admin:
1. 世話記録一覧で「写真あり」を判別できる。
2. 世話記録詳細で画像を閲覧できる。

## 6. 将来拡張時の前提

- 画像保持期間を導入する場合は、`deleted_at` と `missing_at` を混同しない。
- 保持期限で削除する場合は、運用削除イベントを別アクション名で監査ログ化する。
- 通知設計（アプリ内通知/転送通知）は本仕様のスコープ外とし、別設計で扱う。
