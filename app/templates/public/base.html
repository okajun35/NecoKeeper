<!DOCTYPE html>
<html lang="{{ settings.default_language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="保護猫の世話記録を簡単に入力できるアプリ">
    <meta name="theme-color" content="#4f46e5">

    <!-- Conditional Favicon: Kiroween Mode uses Halloween icon -->
    {% if settings.kiroween_mode %}
    <link rel="icon" type="image/webp" href="/static/icons/halloween_icon.webp">
    {% else %}
    <link rel="icon" type="image/svg+xml" href="/static/icons/default_icon.svg">
    {% endif %}

    <title {% block title_attributes %}{% endblock %}>{% block title %}NecoKeeper{% endblock %}</title>

    <!-- PWA Manifest (Dynamic) -->
    <link rel="manifest" href="/manifest.json">
    <!-- Legacy static manifest for clients expecting /static/manifest.json -->
    <link rel="prefetch" href="/static/manifest.json" data-legacy-manifest="true">

    <!-- Apple Touch Icon -->
    {% if settings.kiroween_mode %}
    <link rel="apple-touch-icon" href="/static/icons/halloween_icon.webp">
    {% else %}
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    {% endif %}
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NecoKeeper">

    <!-- Tailwind (always) + Terminal CSS when Kiroween -->
    <script src="https://cdn.tailwindcss.com"></script>
    {% if settings.kiroween_mode %}
    <link rel="stylesheet" href="/static/css/terminal.css">
    {% endif %}

    <!-- i18next for internationalization -->
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>

    <script>
        window.DEFAULT_LANGUAGE = "{{ settings.default_language }}";
    </script>
    <!-- i18n module (with namespaces support) -->
    <script src="/static/js/i18n.js?v={{ settings.static_version }}"></script>

    <script src="/static/js/offline.js"></script>

    {% block extra_head %}{% endblock %}

    <!-- Conditional Monospace Font Override for Kiroween Mode -->
    {% if settings.kiroween_mode %}
    <style>
        * {
            font-family: 'Courier New', Courier, monospace !important;
        }
    </style>
    {% endif %}

    <style>
        /* カスタムスタイル */
        .i18n-hidden {
            display: none;
        }
        .rating-button {
            transition: all 0.2s;
        }
        .rating-button.selected {
            transform: scale(1.1);
        }
    </style>

    {% block extra_styles %}{% endblock %}

    <script>
        // Service Worker登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/js/sw.js')
                    .then(registration => {
                        console.log('[SW] Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.error('[SW] Service Worker registration failed:', error);
                    });
            });
        }

        // API Base URL
        const API_BASE = '/api/v1/public';

        // 今日の日付を取得する関数（ローカルタイムゾーン対応）
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // エラー表示
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (!errorDiv) return;
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            if (!errorDiv) return;
            const errorText = document.getElementById('errorText');
            if (errorText) {
                errorText.textContent = '';
            }
            errorDiv.classList.add('hidden');
        }

        // 成功表示
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            if (!successDiv) return;
            const successText = document.getElementById('successText');
            if (successText) {
                successText.textContent = '✓ ' + message;
            }
            successDiv.classList.remove('hidden');
        }

        function hideSuccess() {
            const successDiv = document.getElementById('successMessage');
            if (successDiv) {
                successDiv.classList.add('hidden');
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen{% if settings.kiroween_mode %} kiroween-mode{% endif %} i18n-hidden">
    {% block content %}{% endblock %}

    {% block extra_scripts %}{% endblock %}
</body>
</html>
