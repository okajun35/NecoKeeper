<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="‰øùË≠∑Áå´„ÅÆ‰∏ñË©±Ë®òÈå≤„ÇíÁ∞°Âçò„Å´ÂÖ•Âäõ„Åß„Åç„Çã„Ç¢„Éó„É™">
    <meta name="theme-color" content="#4f46e5">
    <title>‰∏ñË©±Ë®òÈå≤ÂÖ•Âäõ - NecoKeeper</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NecoKeeper">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/offline.js"></script>
    <style>
        /* „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ */
        .rating-button {
            transition: all 0.2s;
        }
        .rating-button.selected {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-2xl mx-auto p-4 pb-24">
        <!-- „Éò„ÉÉ„ÉÄ„Éº: Áå´ÊÉÖÂ†± -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center gap-4">
                <img id="animalPhoto"
                     src=""
                     alt="Áå´„ÅÆÂÜôÁúü"
                     class="w-24 h-24 rounded-full object-cover border-4 border-indigo-200">
                <div class="flex-1">
                    <h1 id="animalName" class="text-2xl font-bold text-gray-800 mb-1"></h1>
                    <p class="text-sm text-gray-500">‰∏ñË©±Ë®òÈå≤„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>
            </div>
        </div>

        <!-- Êé•Á∂öÁä∂ÊÖã -->
        <div id="connectionStatus" class="mb-4"></div>

        <!-- ÂêåÊúüÁä∂ÊÖã -->
        <div id="syncStatus" class="mb-4"></div>

        <!-- „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ -->
        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
            <p class="font-medium">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</p>
            <p id="errorText" class="text-sm"></p>
        </div>

        <!-- ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏ -->
        <div id="successMessage" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4">
            <p class="font-medium">‚úì Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü</p>
        </div>

        <!-- ÂÖ•Âäõ„Éï„Ç©„Éº„É† -->
        <form id="careForm" class="space-y-6">
            <!-- ÊôÇÁÇπÈÅ∏Êäû -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    ÊôÇÁÇπ <span class="text-red-500">*</span>
                </label>
                <div class="grid grid-cols-3 gap-3">
                    <button type="button"
                            class="time-slot-btn py-3 px-4 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-colors"
                            data-value="morning">
                        üåÖ Êúù
                    </button>
                    <button type="button"
                            class="time-slot-btn py-3 px-4 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-colors"
                            data-value="afternoon">
                        ‚òÄÔ∏è Êòº
                    </button>
                    <button type="button"
                            class="time-slot-btn py-3 px-4 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-colors"
                            data-value="evening">
                        üåô Â§ú
                    </button>
                </div>
                <input type="hidden" id="timeSlot" name="time_slot" required>
            </div>

            <!-- È£üÊ¨≤ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    È£üÊ¨≤ <span class="text-red-500">*</span>
                </label>
                <div class="flex justify-between gap-2">
                    <button type="button"
                            class="appetite-btn rating-button flex-1 py-3 px-2 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            data-value="1">
                        1
                    </button>
                    <button type="button"
                            class="appetite-btn rating-button flex-1 py-3 px-2 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            data-value="2">
                        2
                    </button>
                    <button type="button"
                            class="appetite-btn rating-button flex-1 py-3 px-2 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            data-value="3">
                        3
                    </button>
                    <button type="button"
                            class="appetite-btn rating-button flex-1 py-3 px-2 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            data-value="4">
                        4
                    </button>
                    <button type="button"
                            class="appetite-btn rating-button flex-1 py-3 px-2 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            data-value="5">
                        5
                    </button>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-2 px-1">
                    <span>Â∞ë„Å™„ÅÑ</span>
                    <span>ÊôÆÈÄö</span>
                    <span>Â§ö„ÅÑ</span>
                </div>
                <input type="hidden" id="appetite" name="appetite" required>
            </div>

            <!-- ÂÖÉÊ∞ó -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    ÂÖÉÊ∞ó <span class="text-red-500">*</span>
                </label>
                <div class="flex justify-between gap-2">
                    <button type="button"
                            class="energy-btn rating-button flex-1 py-3 px-2 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            data-value="1">
                        1
                    </button>
                    <button type="button"
                            class="energy-btn rating-button flex-1 py-3 px-2 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            data-value="2">
                        2
                    </button>
                    <button type="button"
                            class="energy-btn rating-button flex-1 py-3 px-2 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            data-value="3">
                        3
                    </button>
                    <button type="button"
                            class="energy-btn rating-button flex-1 py-3 px-2 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            data-value="4">
                        4
                    </button>
                    <button type="button"
                            class="energy-btn rating-button flex-1 py-3 px-2 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all"
                            data-value="5">
                        5
                    </button>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-2 px-1">
                    <span>‰Ωé„ÅÑ</span>
                    <span>ÊôÆÈÄö</span>
                    <span>È´ò„ÅÑ</span>
                </div>
                <input type="hidden" id="energy" name="energy" required>
            </div>

            <!-- ÊéíÂ∞ø„ÉªÊ∏ÖÊéÉ -->
            <div class="bg-white rounded-lg shadow-md p-6 space-y-4">
                <!-- ÊéíÂ∞ø -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        ÊéíÂ∞ø
                    </label>
                    <div class="flex gap-3">
                        <button type="button"
                                class="urination-btn flex-1 py-3 px-4 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-colors"
                                data-value="true">
                            „ÅÇ„Çä
                        </button>
                        <button type="button"
                                class="urination-btn flex-1 py-3 px-4 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-colors"
                                data-value="false">
                            „Å™„Åó
                        </button>
                    </div>
                    <input type="hidden" id="urination" name="urination">
                </div>

                <!-- Ê∏ÖÊéÉ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Ê∏ÖÊéÉ
                    </label>
                    <div class="flex gap-3">
                        <button type="button"
                                class="cleaning-btn flex-1 py-3 px-4 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-colors"
                                data-value="true">
                            Ê∏à
                        </button>
                        <button type="button"
                                class="cleaning-btn flex-1 py-3 px-4 border-2 border-gray-300 rounded-lg text-center font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-colors"
                                data-value="false">
                            Êú™
                        </button>
                    </div>
                    <input type="hidden" id="cleaning" name="cleaning">
                </div>
            </div>

            <!-- „É°„É¢ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-3">
                    „É°„É¢
                </label>
                <textarea id="notes"
                          name="notes"
                          rows="3"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                          placeholder="Ê∞ó„Å´„Å™„Çã„Åì„Å®„Åå„ÅÇ„Çå„Å∞Ë®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
            </div>

            <!-- „Éú„É©„É≥„ÉÜ„Ç£„Ç¢ÈÅ∏Êäû -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <label for="volunteer" class="block text-sm font-medium text-gray-700 mb-3">
                    Ë®òÈå≤ËÄÖ <span class="text-red-500">*</span>
                </label>
                <select id="volunteer"
                        name="recorder_id"
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                </select>
            </div>
        </form>
    </div>

    <!-- Âõ∫ÂÆö„Éï„ÉÉ„Çø„Éº: ‰øùÂ≠ò„Éú„Çø„É≥ -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg">
        <div class="max-w-2xl mx-auto flex gap-3">
            <button type="button"
                    id="copyLastBtn"
                    class="flex-1 py-3 px-6 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                ÂâçÂõûÂÄ§„Ç≥„Éî„Éº
            </button>
            <button type="submit"
                    form="careForm"
                    id="submitBtn"
                    class="flex-1 py-3 px-6 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                ‰øùÂ≠ò
            </button>
        </div>
    </div>

    <script>
        // Service WorkerÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/js/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // URL„Åã„Çâanimal_id„ÇíÂèñÂæó
        const urlParams = new URLSearchParams(window.location.search);
        const animalId = urlParams.get('animal_id');

        if (!animalId) {
            showError('Áå´„ÅÆID„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        }

        // API Base URL
        const API_BASE = '/api/v1/public';

        // Áå´ÊÉÖÂ†±„ÇíÂèñÂæó
        async function loadAnimalInfo() {
            try {
                const response = await fetch(`${API_BASE}/animals/${animalId}`);
                if (!response.ok) throw new Error('Áå´ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');

                const animal = await response.json();
                document.getElementById('animalName').textContent = animal.name || 'ÂêçÂâçÊú™Ë®≠ÂÆö';
                document.getElementById('animalPhoto').src = animal.photo || '/static/images/no-image.png';
            } catch (error) {
                showError(error.message);
            }
        }

        // „Éú„É©„É≥„ÉÜ„Ç£„Ç¢‰∏ÄË¶ß„ÇíÂèñÂæó
        async function loadVolunteers() {
            try {
                const response = await fetch(`${API_BASE}/volunteers`);
                if (!response.ok) throw new Error('„Éú„É©„É≥„ÉÜ„Ç£„Ç¢‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');

                const volunteers = await response.json();
                const select = document.getElementById('volunteer');

                volunteers.forEach(volunteer => {
                    const option = document.createElement('option');
                    option.value = volunteer.id;
                    option.textContent = volunteer.name;
                    select.appendChild(option);
                });
            } catch (error) {
                showError(error.message);
            }
        }

        // „Éú„Çø„É≥„Ç∞„É´„Éº„Éó„ÅÆÈÅ∏ÊäûÂá¶ÁêÜ
        function setupButtonGroup(className, inputId) {
            const buttons = document.querySelectorAll(`.${className}`);
            const input = document.getElementById(inputId);

            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    // ‰ªñ„ÅÆ„Éú„Çø„É≥„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
                    buttons.forEach(btn => {
                        btn.classList.remove('selected', 'border-indigo-600', 'bg-indigo-100', 'text-indigo-700');
                        btn.classList.add('border-gray-300');
                    });

                    // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
                    button.classList.add('selected', 'border-indigo-600', 'bg-indigo-100', 'text-indigo-700');
                    button.classList.remove('border-gray-300');

                    // hidden input„Å´ÂÄ§„ÇíË®≠ÂÆö
                    input.value = button.dataset.value;
                });
            });
        }

        // ÂêÑ„Éú„Çø„É≥„Ç∞„É´„Éº„Éó„ÇíÂàùÊúüÂåñ
        setupButtonGroup('time-slot-btn', 'timeSlot');
        setupButtonGroup('appetite-btn', 'appetite');
        setupButtonGroup('energy-btn', 'energy');
        setupButtonGroup('urination-btn', 'urination');
        setupButtonGroup('cleaning-btn', 'cleaning');

        // ÂâçÂõûÂÄ§„Ç≥„Éî„Éº
        document.getElementById('copyLastBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE}/care-logs/latest/${animalId}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        showError('ÂâçÂõû„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                        return;
                    }
                    throw new Error('ÂâçÂõûÂÄ§„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                const lastLog = await response.json();

                // ÂêÑ„Éï„Ç£„Éº„É´„Éâ„Å´ÂÄ§„ÇíË®≠ÂÆö
                if (lastLog.time_slot) {
                    const timeSlotBtn = document.querySelector(`.time-slot-btn[data-value="${lastLog.time_slot}"]`);
                    if (timeSlotBtn) timeSlotBtn.click();
                }

                if (lastLog.appetite) {
                    const appetiteBtn = document.querySelector(`.appetite-btn[data-value="${lastLog.appetite}"]`);
                    if (appetiteBtn) appetiteBtn.click();
                }

                if (lastLog.energy) {
                    const energyBtn = document.querySelector(`.energy-btn[data-value="${lastLog.energy}"]`);
                    if (energyBtn) energyBtn.click();
                }

                if (lastLog.urination !== null) {
                    const urinationBtn = document.querySelector(`.urination-btn[data-value="${lastLog.urination}"]`);
                    if (urinationBtn) urinationBtn.click();
                }

                if (lastLog.cleaning !== null) {
                    const cleaningBtn = document.querySelector(`.cleaning-btn[data-value="${lastLog.cleaning}"]`);
                    if (cleaningBtn) cleaningBtn.click();
                }

                // „É°„É¢„ÅØ„Ç≥„Éî„Éº„Åó„Å™„ÅÑÔºàÊØéÂõûÁï∞„Å™„ÇãÂèØËÉΩÊÄß„ÅåÈ´ò„ÅÑ„Åü„ÇÅÔºâ

                showSuccess('ÂâçÂõûÂÄ§„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            } catch (error) {
                showError(error.message);
            }
        });

        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Ôºà„Ç™„Éï„É©„Ç§„É≥ÂØæÂøúÔºâ
        document.getElementById('careForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‰øùÂ≠ò‰∏≠...';

            try {
                const formData = {
                    animal_id: parseInt(animalId),
                    time_slot: document.getElementById('timeSlot').value,
                    appetite: parseInt(document.getElementById('appetite').value),
                    energy: parseInt(document.getElementById('energy').value),
                    urination: document.getElementById('urination').value === 'true' ? true :
                               document.getElementById('urination').value === 'false' ? false : null,
                    cleaning: document.getElementById('cleaning').value === 'true' ? true :
                             document.getElementById('cleaning').value === 'false' ? false : null,
                    notes: document.getElementById('notes').value || null,
                    recorder_id: parseInt(document.getElementById('volunteer').value)
                };

                // „Ç™„Éï„É©„Ç§„É≥„Éû„Éç„Éº„Ç∏„É£„Éº„Çí‰ΩøÁî®„Åó„Å¶‰øùÂ≠ò
                const result = await window.offlineManager.saveCareLog(formData);

                if (result.online) {
                    showSuccess('Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                } else {
                    showSuccess('Ë®òÈå≤„Çí‰∏ÄÊôÇ‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºà„Ç™„É≥„É©„Ç§„É≥ÊôÇ„Å´Ëá™ÂãïÂêåÊúü„Åï„Çå„Åæ„ÅôÔºâ');
                }

                // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                setTimeout(() => {
                    document.getElementById('careForm').reset();
                    // „Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
                    document.querySelectorAll('.selected').forEach(btn => {
                        btn.classList.remove('selected', 'border-indigo-600', 'bg-indigo-100', 'text-indigo-700');
                        btn.classList.add('border-gray-300');
                    });
                    // hidden input„Çí„ÇØ„É™„Ç¢
                    ['timeSlot', 'appetite', 'energy', 'urination', 'cleaning'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    hideSuccess();
                }, 2000);

            } catch (error) {
                showError(error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '‰øùÂ≠ò';
            }
        });

        // „Ç®„É©„ÉºË°®Á§∫
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        // ÊàêÂäüË°®Á§∫
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.querySelector('p').textContent = '‚úì ' + message;
            successDiv.classList.remove('hidden');
        }

        function hideSuccess() {
            document.getElementById('successMessage').classList.add('hidden');
        }

        // ÂàùÊúüÂåñ
        loadAnimalInfo();
        loadVolunteers();
    </script>
</body>
</html>
